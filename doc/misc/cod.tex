%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{\label{sec:cod}Computing On Demand (COD)}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{COD (Computing on Demand)|(}
\index{Computing on Demand (see COD)}

\index{COD!introduction} 
Computing On Demand (COD) extends HTCondor's high throughput
computing abilities to include
a method for running short-term jobs on instantly-available resources.

The motivation for COD extends HTCondor's job management to
include interactive, compute-intensive jobs,
giving these jobs immediate access to the
compute power they need over a relatively short period of time.
COD provides
computing power \emph{on demand}, 
switching predefined resources from working on HTCondor jobs
to working on the COD jobs. 
These COD jobs (applications) cannot use the batch
scheduling functionality of HTCondor, since the COD jobs require
interactive response-time.
Many of the applications that are well-suited to HTCondor's
COD capabilities involve a cycle:
application blocked on user input, computation burst to compute
results, block again on user input, computation burst, etc.
When the resources are not being used for the bursts of computation to
service the application, they should continue to execute
long-running batch jobs.

Here are examples of applications that may benefit from COD capability:

\begin{itemize}

\item A giant spreadsheet with a large number of highly complex
  formulas which take a lot of compute power to recalculate.
  The spreadsheet application (as a COD application) predefines
  a claim on resources within the HTCondor pool.
  When the user presses a \verb@recalculate@ button, 
  the predefined HTCondor resources (nodes) 
  work on the computation and send the results
  back to the master application providing the user interface and
  displaying the data.
  Ideally, while the user is entering new data or modifying formulas,
  these nodes work on non-COD jobs.
  %should not tie up the batch resources where they are running.

\item A graphics rendering application that waits for user
  input to select an image to render.
  The rendering requires a huge burst
  of computation to produce the image.
  Examples are various Computer-Aided Design (CAD) tools, fractal
  rendering programs, and ray-tracing tools.
 
\item Visualization tools for data mining.

\end{itemize}

The way HTCondor helps these kinds of applications is to provide an
infrastructure to use HTCondor batch resources for the types of compute
nodes described above.
HTCondor does \emph{NOT} provide tools to parallelize existing GUI
applications.
The COD functionality is an interface to allow these compute nodes to
interact with long-running HTCondor batch jobs.
The user provides both the compute node applications and the
interactive master application that controls them.
HTCondor only provides a mechanism to allow these interactive (and often
parallelized) applications to seamlessly interact with the HTCondor
batch system.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{\label{sec:cod-overview}
Overview of How COD Works}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{COD!overview} 

The resources of an HTCondor pool (nodes)
run jobs.
When a high-priority COD job appears at a node,
the lower-priority (currently running) batch job is
suspended.
The COD job runs immediately, while the batch job remains suspended.
When the COD job completes, the batch job instantly resumes execution.

Administratively,
an interactive COD application puts claims on nodes.
While the COD application does not need the nodes to run the
COD jobs,  the claims are suspended, allowing batch jobs to run.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{\label{sec:cod-authorizing}
Authorizing Users to Create and Manage COD Claims}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{COD!authorizing users} 

Claims on nodes are assigned to users.
A user with a claim on a resource can then suspend and
resume a COD job at will.
This gives the user a great deal of power on the claimed resource,
even if it is owned by another user.
Because of this, it is essential that users allowed to claim
COD resources can be
trusted not to abuse this power.
Users are authorized to have access to the privilege
of creating and using a COD claim on a machine.
This privilege is granted when the HTCondor administrator places a given
user name in the \Macro{VALID\_COD\_USERS} list in the HTCondor
configuration for the machine (usually in a local configuration file).

In addition, the tools to request and manage COD claims
require that the user issuing the commands be authenticated. 
Use one of the strong authentication methods described
in section~\ref{sec:Config-Security} on HTCondor's Security Model.
If one of these methods cannot be used,
then file system authentication may be used
when directly logging in to that machine (to be claimed)
and issuing the command locally.
%This is analogous to commands that submit or remove jobs from the job
%queue managed by a given \Condor{schedd}.
%Unless some form of strong authentication such as GSI or Kerberos is
%enabled at your HTCondor pool, you must issue \Condor{submit} and
%\Condor{rm} commands from the same machine where the \Condor{schedd}
%is running.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{\label{sec:cod-setup}
Defining a COD Application}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{COD!defining an application} 

To run an application on a claimed COD resource,
an authorized user defines 
characteristics of the application.
Examples of characteristics are the executable or script to use,
the directory in which to run the application,
command-line arguments, and
files to use for standard input and output.
COD users specify a ClassAd that describes these characteristics
for their application.  
There are two ways for a user to define a COD application's ClassAd:

\begin{enumerate}
\item in the HTCondor configuration files of the COD resources
\item when they use the \Condor{cod} command-line tool to launch the
application itself
\end{enumerate}

These two methods for defining the ClassAd can be used together.
For example, the user can define some attributes
in the configuration file, and only provide a few dynamically defined
attributes with the \Condor{cod} tool.

Independent of how the COD application's ClassAd is defined,
the application's executable and input
data must be pre-staged at the node.
This is a current limitation of HTCondor's support.
There is no mechanism to transfer files for a COD application, 
and all I/O must be handled locally or put onto a network
file system that is accessible by a node.

The following three sections detail defining the attributes.
The first lists the attributes that can be used to define a COD
application.
The second describes how to define these attributes in an HTCondor
configuration file.
The third explains how to define these attributes using the \Condor{cod} tool.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:cod-application-attributes}
COD Application Attributes}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\index{COD!attributes} 
\index{Computing On Demand!Defining Applications!Required attributes}

Attributes for a COD application are either required
or optional.
The following attributes are \emph{required}:
\index{COD!required attributes} 

\begin{description}

 \item[\Attr{Cmd}] This attribute 
\index{COD!required attributes!Cmd} 
   defines the full path to the executable program to be run as a
   COD application.
   Since HTCondor does not currently provide any mechanism to transfer
   files on behalf of COD applications, this path should be a valid
   path on the machine where the application will be run.
   It is a string attribute, and must therefore be enclosed in
   quotation marks (\verb@"@).
   There is no default.

 \item[\Attr{Owner}] If the \Condor{startd} daemon is executing as root on
\index{COD!required attributes!Owner} 
   the resource where a COD application will run, the user must also
   define \Attr{Owner} to specify what user name the application will
   run as.
   On Windows, the \Condor{startd} daemon always runs as an Administrator
   service, which is equivalent to running as root on Unix platforms.
   If the user specifies any COD application attributes with the
   \Condor{cod} \Arg{activate} command-line tool, the \Attr{Owner}
   attribute will be defined as the user name that ran
   \Condor{cod} \Arg{activate}.
   However, if the user defines all attributes of their COD
   application in the HTCondor configuration files, and does not define
   any attributes with the \Condor{cod} \Arg{activate} command-line tool,
   there is no default,
    and \Attr{Owner} must be specified in the configuration file.
   \Attr{Owner} must contain a valid user
   name on the given COD resource. 
   It is a string attribute, and must therefore be enclosed in 
   quotation marks (\verb@"@).

 \item[\Attr{RequestCpus}] Required when running on a \Condor{startd}
\index{COD!required attributes!RequestCpus} 
that uses partitionable slots.  
It specifies the number of CPU cores from the partitionable slot
allocated for this job.

 \item[\Attr{RequestDisk}] Required when running on a \Condor{startd}
\index{COD!required attributes!RequestDisk} 
that uses partitionable slots.  
It specifies the disk space, in Megabytes,
from the partitionable slot allocated for this job.

 \item[\Attr{RequestMemory}] Required when running on a \Condor{startd}
\index{COD!required attributes!RequestMemory} 
that uses partitionable slots.  
It specifies the memory, in Megabytes,
from the partitionable slot allocated for this job.


\end{description}

\index{COD!optional attributes} 
\index{Computing On Demand!Defining Applications!Optional attributes}

The following list of attributes are \emph{optional}:

\begin{description}

 \item[\Attr{JobUniverse}] This attribute defines what HTCondor job
\index{COD!optional attributes!JobUniverse} 
   universe to use for the given COD application.
   The only tested universes are vanilla and java.
   This attribute must be an integer, with vanilla using the value 5,
   and java using the value 10.

 \item[\Attr{IWD}] IWD is an acronym for Initial Working Directory.
\index{COD!optional attributes!IWD} 
   It defines the full path to the directory where a given COD
   application are to be run.
   Unless the application changes its current working directory, any
   relative path names used by the application will be relative to
   the IWD.
   If any other attributes that define file names (for example,
   \Attr{In}, \Attr{Out}, and so on) do not contain a full path, the
   \Attr{IWD} will automatically be pre-pended to those file names.
   It is a string attribute, and must therefore be enclosed in 
   quotation marks (\verb@"@).
   If the \Attr{IWD} is not specified, the temporary execution sandbox
   created by the \Condor{starter} will be used as the initial working
   directory.

 \item[\Attr{In}] This string defines the path to the file on the
\index{COD!optional attributes!In} 
   COD resource that should be used as standard input (\File{stdin}) for 
   the COD application.
   This file (and all parent directories) must be readable by whatever
   user the COD application will run as.
   If not specified, the default is \File{/dev/null}.
   It is a string attribute, and must therefore be enclosed in 
   quotation marks (\verb@"@).
 
 \item[\Attr{Out}] This string defines the path to the file on the
\index{COD!optional attributes!Out} 
   COD resource that should be used as standard output (\File{stdout})
   for the COD application.
   This file must be writable (and all parent directories readable) by
   whatever user the COD application will run as.
   If not specified, the default is \File{/dev/null}.
   It is a string attribute, and must therefore be enclosed in 
   quotation marks (\verb@"@).
 
 \item[\Attr{Err}] This string defines the path to the file on the
\index{COD!optional attributes!Err} 
   COD resource that should be used as standard error (\File{stderr})
   for the COD application.
   This file must be writable (and all parent directories readable) by
   whatever user the COD application will run as.
   If not specified, the default is \File{/dev/null}.
   It is a string attribute, and must therefore be enclosed in 
   quotation marks (\verb@"@).

 \item[\Attr{Env}] This string defines environment variables to
\index{COD!optional attributes!Env} 
   set for a given COD application.
   Each environment variable has the form \verb@NAME=value@.
   Multiple variables are delimited with a semicolon.
   An example: \verb@Env = "PATH=/usr/local/bin:/usr/bin;TERM=vt100"@ 
   It is a string attribute, and must therefore be enclosed in 
   quotation marks (\verb@"@).

 \item[\Attr{Args}] This string attribute defines the list of
\index{COD!optional attributes!Args} 
   arguments to be supplied to the program on the command-line.
   The arguments are delimited (separated) by space characters. 
   There is no default. 
   If the \Attr{JobUniverse} corresponds to the Java
   universe, the first argument must be the name of the class
   containing \Code{main}.
   It is a string attribute, and must therefore be enclosed in 
   quotation marks (\verb@"@).

 \item[\Attr{JarFiles}] This string attribute is only used if
\index{COD!optional attributes!JarFiles} 
   \Attr{JobUniverse} is 10 (the Java universe).
   If a given COD application is a Java program, specify the
   JAR files that the program requires with this attribute.
   There is no default.
   It is a string attribute, and must therefore be enclosed in 
   quotation marks (\verb@"@).
   Multiple file names may be delimited with either commas or white space
   characters, and
   therefore, file names can not contain spaces.

 \item[\Attr{KillSig}] This attribute specifies what signal should be
\index{COD!optional attributes!KillSig} 
   sent whenever the HTCondor system needs to gracefully shutdown the
   COD application.
   It can either be specified as a string containing the signal name
   (for example \verb@KillSig = "SIGQUIT"@), or as an integer
   (\verb@KillSig = 3@)
   The default is to use SIGTERM.

 \item[\Attr{StarterUserLog}] This string specifies a file name for a
\index{COD!optional attributes!StarterUserLog} 
   log file that the \Condor{starter} daemon can write with entries
   for relevant 
   events in the life of a given COD application.
   It is similar to the job event log file specified for regular HTCondor
   jobs with the \SubmitCmd{Log} command in a submit description
   file.
   However, certain attributes that are placed in a job event log
   do not make sense in the COD environment, and are therefore
   omitted.
   The default is not to write this log file.
   It is a string attribute, and must therefore be enclosed in 
   quotation marks (\verb@"@).

 \item[\Attr{StarterUserLogUseXML}] If the \Attr{StarterUserLog}
\index{COD!optional attributes!StarterUserLogUseXML} 
   attribute is defined, the default format is a
   human-readable format.
   However, HTCondor can write out this log in an XML representation,
   instead.
   To enable the XML format for this job event log, the
   \Attr{StarterUserLogUseXML} boolean is set to \verb@TRUE@.
   The default if not specified is \verb@FALSE@.

\end{description}

If any attribute that specifies a path (\Attr{Cmd}, \Attr{In},
\Attr{Out},\Attr{Err}, \Attr{StarterUserLog}) is not a full path name,
HTCondor automatically prepends the value of \Attr{IWD}.


\index{Computing On Demand!Defining Applications!Job ID}
\index{COD!defining applications!Job ID}

The final set of attributes define an identification for a COD application.
The job ID is made up of both the \Attr{ClusterId} and \Attr{ProcId}
attributes.
This job ID is similar to the job ID that is created whenever a
regular HTCondor batch job is submitted.
For regular HTCondor batch jobs, the job ID is assigned automatically by
the \Condor{schedd} whenever a new job is submitted into the
persistent job queue.
However, since there is no persistent job queue for COD, the usual
mechanism to identify jobs does not exist.
Moreover, commands that require the job ID for batch jobs such as
\Condor{q} and \Condor{rm} do not exist for COD.
Instead, the claim ID is the unique identifier for COD jobs and
COD-related commands.

When using COD, the job ID is only used to identify the job in various
log messages and in the COD-specific output of \Condor{status}.
The COD job ID is part of the information included in all
events written to the \Attr{StarterUserLog}
regarding a given job.
The COD job ID is also used in the HTCondor debugging logs described in
section~\ref{sec:Daemon-Logging-Config-File-Entries} on
page~\pageref{sec:Daemon-Logging-Config-File-Entries}.
For example, in the \Condor{starter} daemon's log file for COD jobs
(called \File{StarterLog.cod} by default) or in the \Condor{startd}
daemon's log
file (called \File{StartLog} by default).

These COD job IDs are optional.
The job ID is useful to define where it helps a
user with the accounting or debugging of their own application.
In this case, it is the user's responsibility to ensure uniqueness,
if so desired.
  
\begin{description}
 \item[\Attr{ClusterId}] This integer defines the
\index{COD!attributes!ClusterId} 
   cluster identifier for a COD job.
   The default value is 1.
   The \Attr{ClusterId} can also be defined with the
\index{COD!condor\_cod activate command} 
   \Condor{cod} \Arg{activate} command-line tool using the \Opt{-cluster}
   option.

 \item[\Attr{ProcId}]  This integer defines the
\index{COD!attributes!ProcID} 
   process identifier (within a cluster) for a COD job.
   The default value is 0.
   The \Attr{ProcId} can also be defined with the
   \Condor{cod} \Arg{activate} command-line tool using the \Opt{-cluster}
   option.

\end{description}

Note that the \Attr{ClusterId} and \Attr{ProcId} identifiers can 
also be specified as
command-line arguments to the \Condor{cod} \Arg{activate} when
spawning a given COD application.
See section~\ref{sec:cod-claim-activate} below for details on using
\Condor{cod} \Arg{activate}. 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:cod-config-attrs}
Defining Attributes in the HTCondor Configuration Files}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{COD!defining attributes by configuration} 


To define COD attributes in the HTCondor configuration file for a given
application, the user selects a keyword to uniquely name 
ClassAd attributes of the application.
This case-insensitive keyword is used as a prefix for the various
configuration file variable names.
When a user wishes to spawn a given application, the
keyword is given as an argument to the \Condor{cod} tool, and the keyword
is used at the remote COD resource to find attributes which define the
application.

Any of the ClassAd attributes described in the previous section can be
specified in the configuration file with the keyword prefix followed
by an underscore character (\verb@"_"@).

For example, if the user's keyword for a given fractal generation
application is \Expr{FractGen}, the resulting entries in the HTCondor
configuration file may appear as:

\begin{verbatim}
FractGen_Cmd = "/usr/local/bin/fractgen"
FractGen_Iwd = "/tmp/cod-fractgen"
FractGen_Out = "/tmp/cod-fractgen/output"
FractGen_Err = "/tmp/cod-fractgen/error"
FractGen_Args = "mandelbrot -0.65865,-0.56254 -0.45865,-0.71254"
\end{verbatim}

In this example, the executable may create other files.
The \Attr{Out} and \Attr{Err} attributes specified in the
configuration file are only for standard output and standard error
redirection.

When the user wishes to spawn an instance of this application,
the command line 
  \verb@condor_cod  activate@
appears with the
  \verb@-keyword FractGen@
option.

\Note If a user is defining all attributes of their COD application in
the HTCondor configuration files, and the \Condor{startd} daemon on the COD
resource they are using is running as root, the user must also define
\Attr{Owner} to be the user that the COD application should run as.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:cod-command-line-attrs}
Defining Attributes with the \Condor{cod} Tool} 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{COD!condor\_cod tool} 

COD users may define attributes dynamically (at the time they spawn a
COD application).
In this case, the user writes the ClassAd attributes into a file, and the
file name is passed to the \Condor{cod} \Arg{activate} command  using the
\Opt{-jobad} option.
These attributes are read by the \Condor{cod} tool and passed through
the system to the \Condor{starter} daemon, which spawns the COD application. 
If the file name given is \File{-}, the \Condor{cod} tool will read
from standard input (\File{stdin}).

Users should not add a keyword prefix 
when defining attributes with \Condor{cod} \Arg{activate}.
The attribute names can be used in the file directly.

\Warn The current syntax for this file is not the same as the syntax
in the file used with \Condor{submit}.

\Note Users should not define the \Attr{Owner} attribute
when using \Condor{cod} \Arg{activate} on the command line, since HTCondor
will automatically insert the correct value based on what user runs the
\Condor{cod} command and how that user authenticates to the
COD resource.
If a user defines an attribute that does not match the authenticated
identity, HTCondor treats this case as an error, and it will fail to launch the
application.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{\label{sec:cod-managing-claims}
Managing COD Resource Claims}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{COD!managing claims} 

Separate commands are provided by HTCondor to manage COD
claims on batch resources.
Once created, each COD claim has a unique identifying string, called the
claim ID.
Most commands require a claim ID to specify which claim you wish to
act on. 
These commands are the means by which COD applications interact with
the rest of the HTCondor system.
They should be issued by the controller application to manage its
compute nodes.
Here is a list of the commands:

\begin{description}

\item [Request] Create a new COD claim on a given resource.

\item [Activate] Spawn a specific application on a specific COD claim.

\item [Suspend] Suspend a running application within a specific COD claim.

\item [Renew] Renew the lease to a COD claim.

\item [Resume] Resume a suspended application on a specific COD claim.

\item [Deactivate] Shut down an application, but hold onto the COD claim
  for future use.

\item [Release] Destroy a specific COD claim, and shut down any job that is
  currently running on it.

\item [Delegate proxy] Send an x509 proxy credential to the specific
  COD claim (optional, only required in rare cases like using glexec
  to spawn the \Condor{starter} at the execute machine where the COD
  job is running).

\end{description}

To issue these commands, a user or application invokes the 
\Condor{cod} tool.
A command may be specified as the first argument to this tool, 
as
% note: there's no '-' in front of 'request'.  that's on purpose, not
% a typo.  that's how it really works...
\begin{verbatim}
condor_cod request -name c02.cs.wisc.edu
\end{verbatim}
or
the \Condor{cod} tool can be installed in such a way that the same
binary is used for a set of names, as
\begin{verbatim}
condor_cod_request -name c02.cs.wisc.edu
\end{verbatim}

Other than the command name itself (which must be included in full)
additional options supported by each tool can be abbreviated to the
shortest unambiguous value.
For example, \Opt{-name} can also be specified as \Opt{-n}.
However, for a command like \Condor{cod\_activate} that supports both
\Opt{-classad} and \Opt{-cluster}, the user must use at least
\Opt{-cla} or \Opt{-clu}.
If the user specifies an ambiguous option, the \Condor{cod} tool will
exit with an error message.

In addition, there is a \Opt{-cod} option to \Condor{status}.

The following sections describe each option in greater detail.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:cod-claim-request}Request}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{COD!condor\_cod\_request command} 

A user must be granted authorization to create COD
claims on a specific machine.
In addition, when the user uses these COD claims, the application
binary or script they wish to run (and any input data) must be
pre-staged on the machine.
% Karen says that previous stuff in this file makes this
% statement not true, since it can be done with config or
% command-line arguments
%and
%defined in the \File{condor\_config} file (or a local config file). 
% But derek reminds karen that the application itself must be
% pre-staged, since there's no file transfer with COD.  so, even
% though the configuration doesn't have to be pre-staged, the actual
% binary you wish to run *does* have to be there.
Therefore, a user cannot simply request a COD claim at random.

The user specifies the resource on which to make a COD claim.
This is accomplished by specifying the name of the
\Condor{startd} daemon desired by invoking
\Condor{cod\_request} with the \Opt{-name} option and the
resource name (usually the host name).
For example:
\begin{verbatim}
condor_cod_request -name c02.cs.wisc.edu
\end{verbatim}

If the \Condor{startd} daemon desired belongs to a different HTCondor
pool than the one where executing the COD commands,
use the \Opt{-pool} option to provide the name of the central manager
machine of the other pool.  For example:
\begin{verbatim}
condor_cod_request -name c02.cs.wisc.edu -pool condor.cs.wisc.edu
\end{verbatim}

An alternative is to provide the IP address and port number
where the \Condor{startd} daemon is listening
with the \Opt{-addr} option.
This information can be found in the \Condor{startd} ClassAd as the
attribute \Attr{StartdIpAddr} or by reading the log file when the
\Condor{startd} first starts up.
For example:
\begin{verbatim}
condor_cod_request -addr "<128.105.146.102:40967>"
\end{verbatim}
  
If neither \Opt{-name} or \Opt{-addr} are specified,
\Condor{cod\_request} attempts to connect to the \Condor{startd}
daemon running
on the local machine (where the request command was issued).

If the \Condor{startd} daemon to be used for the COD claim is an SMP
machine and has multiple slots, specify which resource on
the machine to use for COD by providing the full name of the resource,
not just the host name.
For example:
\begin{verbatim}
condor_cod_request -name slot2@c02.cs.wisc.edu
\end{verbatim}

A constraint on what slot is desired may be provided,
instead of specifying it by name.  
For example, to run on machine c02.cs.wisc.edu,
not caring which slot is used,
so long as it the machine is not currently running a job,
use something like:
\begin{verbatim}
condor_cod_request -name c02.cs.wisc.edu -requirements 'State!="Claimed"'
\end{verbatim}

In general, be careful with shell quoting issues, so that
your shell is not confused by the ClassAd expression syntax (in
particular if the expression includes a string).
The safest method is to enclose any requirement expression
within single quote marks (as shown above).
 
Once a given \Condor{startd} daemon has been contacted to request a new COD
claim, the \Condor{startd} daemon checks for proper
authorization of the user
issuing the command.
If the user has the authority, and the \Condor{startd} daemon
finds a
resource that matches any given requirements,
the \Condor{startd} daemon
creates a new COD claim and gives it a unique identifier,
the claim ID.
This ID is used to identify COD claims when using other commands.
If \Condor{cod\_request} succeeds, the claim ID for the new claim is printed
out to the screen.
All other commands to manage this claim require the claim ID to be
provided as a command-line option.

When the \Condor{startd} daemon assigns a COD claim,
the ClassAd describing the resource is returned to the user that
requested the claim. 
This ClassAd is a snap-shot of 
the output of \verb@condor_status -long@ for the given machine.
If \Condor{cod\_request} is invoked with the \Opt{-classad} option
(which takes a file name as an argument), this ClassAd will be written
out to the given file.
Otherwise, the ClassAd is printed to the screen.
The only essential piece of information in this ClassAd is the Claim
ID, so that is printed to the screen, even if the whole ClassAd is
also being written to a file.

The claim ID as given after listing the machine ClassAd appears as
this example:
\footnotesize
\begin{verbatim}
ID of new claim is: "<128.105.121.21:49973>#1073352104#4"
\end{verbatim}
\normalsize
When using this claim ID in further commands, include the quote
marks as well as all the characters in between the quote marks.

\Note Once a COD claim is created, there is no persistent record of it
kept by the \Condor{startd} daemon.
So, if the \Condor{startd} daemon is restarted for any reason, all existing
COD claims will be destroyed and the new \Condor{startd} daemon will not
recognize any attempts to use the previous claims.

Also note that it is your responsibility to ensure that the claim is
eventually removed (see section~\ref{sec:cod-claim-release}).  Failure
to remove the COD claim will result in the \Condor{startd} continuing
to hold a record of the claim for as long as \Condor{startd} continues
running.  If a very large number of such claims are accumulated by the
\Condor{startd}, this can impact its performance.  Even worse: if a
COD claim is unintentionally left in an activated state, this results
in the suspension of any batch job running on the same resource for as
long as the claim remains activated.  For this reason, an optional
\Opt{-lease} argument is supported by \Condor{cod\_request}.  This
tells the \Condor{startd} to automatically release the COD claim after
the specified number of seconds unless the lease is renewed with
\Condor{cod\_renew}.  The default lease is infinitely long.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:cod-claim-activate}Activate}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{COD!condor\_cod\_activate command} 

Once a user has created a valid COD claim and has the claim ID, the
next step is to spawn a COD job using the claim.
The way to do this is to activate the claim, using the
\Condor{cod\_activate} command.
Once a COD application is active on a COD claim, the COD claim will
move into the \verb@Running@ state, and any batch HTCondor job
on the same resource will be suspended.
Whenever the COD application is inactive (either suspended, removed
from the machine, or if it exits on its own), the state of the COD
claim changes. The new state depends on why the application
became inactive. 
The batch HTCondor job then resumes.

To activate a COD claim, first define attributes about
the job to be run in either the local configuration of the COD
resource, or in a separate file as described in this manual section.
Invoke the
\Condor{cod\_activate} command to launch a specific instance of the
job on a given COD claim ID.
The options given to \Condor{cod\_activate} vary depending on if the
job attributes are defined in the configuration file or are
passed via a file to the \Condor{cod\_activate} tool itself.
However, the \Opt{-id} option is always required by
\Condor{cod\_activate}, and this option should be followed
by a COD claim ID that
the user acquired via \Condor{cod\_request}.


If the application is defined in the configuration files for the COD
resource, the user provides the keyword (described in
section~\ref{sec:cod-config-attrs}) that uniquely identifies the
application's configuration attributes.
To continue the example from that section, the user would spawn their
job by specifying \verb@-keyword FractGen@, for example:
\begin{verbatim}
condor_cod_activate -id "<claim_id>" -keyword FractGen
\end{verbatim}
Substitute the \verb@<claim_id>@ with the valid Cod Claim Id.
Using the same example as given above, this example would be:
\footnotesize
\begin{verbatim}
condor_cod_activate -id "<128.105.121.21:49973>#1073352104#4" -keyword FractGen
\end{verbatim}
\normalsize

If the job attributes are placed into a file to be passed to the
\Condor{cod\_activate} tool,
the user must provide the
name of the file using the \Opt{-jobad} option.
For example, if the job attributes were defined in a file named
\File{cod-fractgen.txt}, the user spawns the job using the
command:
\begin{verbatim}
condor_cod_activate -id "<claim_id>" -jobad cod-fractgen.txt
\end{verbatim}
Alternatively, if the filename specified with \Opt{-jobad} is
\File{-}, the \Condor{cod\_activate} tool reads the job ClassAd from
standard input (\File{stdin}).

Regardless of how the job attributes are defined, there are
other options that \Condor{cod\_activate} accepts.
These options specify the job ID for the application to be run.
The job ID can either be specified in the job's ClassAd, 
or it can be
specified on the command line to \Condor{cod\_activate}.
These options are \Opt{-cluster} and \Opt{-proc}.
For example, to launch a COD job with keyword \verb@foo@
as cluster 23, proc 5, or 23.5,
the user invokes:
\begin{verbatim}
condor_cod_activate -id "<claim_id>" -key foo -cluster 23 -proc 5
\end{verbatim}
The \Opt{-cluster} and \Opt{-proc} arguments are optional,
since the job ID is not required for COD.
If not specified, the job ID defaults to \verb@1.0@.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:cod-claim-suspend}Suspend}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{COD!condor\_cod\_suspend command} 

Once a COD application has been activated with \Condor{cod\_activate}
and is running on a COD resource, it may be temporarily suspended
using \Condor{cod\_suspend}.
In this case, the claim state becomes \verb@Suspended@.
Once a given COD job is suspended, if there are no other running COD
jobs on the resource, an HTCondor batch job can use the resource.
By suspending the COD application, the batch job is allowed to run.
If a resource is idle when a COD application is first spawned,
suspension of the COD job makes the batch resource available
for use in the HTCondor system.
Therefore, whenever a COD application has no work to perform, it should be
suspended to prevent the resource from being wasted.

The interface of \Condor{cod\_suspend}
supports the single option \Opt{-id}, to specify the COD claim ID
to be suspended.
For example:
\begin{verbatim}
condor_cod_suspend -id "<claim_id>"
\end{verbatim}

If the user attempts to suspend a COD job that is not running,
\Condor{cod\_suspend} exits with an error message.
The COD job may not be running 
because it is already suspended or because the job was never spawned on
the given COD claim in the first place.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:cod-claim-renew}Renew}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{COD!condor\_cod\_renew command} 

This command tells the \Condor{startd} to renew the lease on the COD
claim for the amount of lease time specified when the claim was
created.  See section~\ref{sec:cod-claim-request} for more information
on using leases.

The \Condor{cod\_renew} tool supports only the \Opt{-id} option to
specify the COD claim ID the user wishes to renew.
For example:
\begin{verbatim}
condor_cod_renew -id "<claim_id>"
\end{verbatim}

If the user attempts to renew a COD job that no longer exists,
\Condor{cod\_renew} exits with an error message.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:cod-claim-resume}Resume}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{COD!condor\_cod\_resume command} 

Once a COD application has been suspended with \Condor{cod\_suspend},
it can be resumed using \Condor{cod\_resume}.
In this case, the claim state returns to \verb@Running@.
If there is a regular batch job running on the same resource, it will
automatically be suspended if a COD application is resumed.

The \Condor{cod\_resume} tool supports only the \Opt{-id} option to
specify the COD claim ID the user wishes to resume.
For example:
\begin{verbatim}
condor_cod_resume -id "<claim_id>"
\end{verbatim}

If the user attempts to resume a COD job that is not suspended,
\Condor{cod\_resume} exits with an error message.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:cod-claim-deactivate}Deactivate}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{COD!condor\_cod\_deactivate command} 

If a given COD application does not exit on its own and needs to be
removed manually, invoke the \Condor{cod\_deactivate}
command to kill the job, but leave the COD claim ID valid for future
COD jobs.
The user must specify the claim ID they wish to deactivate using the
\Opt{-id} option.
For example:
\begin{verbatim}
condor_cod_deactivate -id "<claim_id>"
\end{verbatim}

By default, \Condor{cod\_deactivate} attempts to gracefully cleanup
the COD application and give it time to exit.
In this case the COD claim goes into the \verb@Vacating@ state and the
\Condor{starter} process controlling the job will send it the 
\Attr{KillSig} defined for the job (SIGTERM by default).
This allows the COD job to catch the signal and do whatever final work
is required to exit cleanly.

However, if the program is stuck or if the user does not want to give
the application time to clean itself up, the user may use the
\Opt{-fast} option to tell the \Condor{starter} to quickly kill the
job and all its descendants using SIGKILL.
In this case the COD claim goes into the \verb@Killing@ state.
For example:
\begin{verbatim}
condor_cod_deactivate -id "<claim_id>" -fast
\end{verbatim}

In either case, once the COD job has finally exited, the COD claim
will go into the \verb@Idle@ state and will be available for future
COD applications.
If there are no other active COD jobs on the same resource, the
resource would become available for batch HTCondor jobs. 
Whenever the user wishes to spawn another COD application, they can
reuse this idle COD claim by using the same claim ID, without having
to go through the process of running \Condor{cod\_request}.

If the user attempts a \Condor{cod\_deactivate} request on a COD claim
that is neither \verb@Running@ nor \verb@Suspended@, the \Condor{cod}
tool exits with an error message.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:cod-claim-release}Release}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{COD!condor\_cod\_release command} 

If users no longer wish to use a given COD claim,
they can release the claim with the \Condor{cod\_release} command.
If there is a COD job running on the claim,
the job will first be shut down (as if \Condor{cod\_deactivate} was
used),
and then the claim itself is removed from the resource and the claim
ID is destroyed. 
Further attempts to use the claim ID for any COD commands will fail.

The \Condor{cod\_release} command always prints out the state the
COD claim was in when the request was received.
This way, users can know what state a given COD application was in
when the claim was destroyed.

Like most COD commands, \Condor{cod\_release} requires the claim ID to
be specified using \Opt{-id}.
In addition, \Condor{cod\_release} supports the \Opt{-fast} option
(described above in the section about \Condor{cod\_deactivate}).
If there is a job running or suspended on the claim when it is
released with \verb@condor_cod_release -fast@, the job will be
immediately killed. 
If \Opt{-fast} is not specified, the default behavior is to use a
graceful shutdown, sending whatever signal is specified in the
\Attr{KillSig} attribute for the job (SIGTERM by default).

% Karen has read to this point in this file. 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{\label{sec:cod-claim-delegate}Delegate proxy}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{COD!condor\_cod\_delegate\_proxy command} 

In some cases, a user will want to delegate a copy of their user
credentials (in the form of an x509 proxy) to the machine where one of
their COD jobs will run.
For example, sites wishing to spawn the \Condor{starter} using glexec
will need a copy of this credential before the claim can be activated.
Therefore, beginning with HTCondor version 6.9.2, COD users have access
to a the command \verb@delegate_proxy@.
If users do not specifically require this proxy delegation, this
command should not be used and the rest of this section can be skipped.

The \verb@delegate_proxy@ command optionally takes a \Opt{-x509proxy}
argument to specify the path to the proxy file to use.
Otherwise, it uses the same discovery logic that \Condor{submit} uses
to find the user's currently active proxy.

Just like every other COD command (except \verb@request@), this
command requires a valid COD claim id (specified with \Opt{-id}) to
indicate what COD claim you wish to delegate the credentials to.

This command can only be sent to idle COD claims, so it should be done
before \verb@activate@ is run for the first time.
However, once a proxy has been delegated, it can be reused by
successive claim activations, so normally this step only has to happen
once, not before every activate.
If a proxy is going to expire, and a new one should be sent, this
should only happen after the existing COD claim has been deactivated.


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{\label{sec:cod-limitations}Limitations of COD Support in HTCondor}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\index{COD!limitations} 

HTCondor's support for COD has a few limitations:

\begin{itemize}

\item Applications and data must be pre-staged at a given machine. 

\item There is no way to define limits for how long a given COD claim
  can be active and how often it is run.

\item There is no accounting done for applications run under COD claims.
  Therefore, use of a lot of COD resources in a given HTCondor pool
  does not adversely affect user priority.

\item COD claims are not persistent on a given \Condor{startd} daemon.

\item HTCondor does not provide a mechanism to parallelize a graphic
  application to take advantage of COD.  
  The HTCondor Team is not in the business of developing applications,
  we only provide mechanisms to execute them.

\end{itemize}
\index{COD (Computing on Demand)|)}
