\begin{ManPage}{\label{man-condor-annex}\Condor{annex}}{1}
{Add cloud resources to the pool.}
\index{HTCondor commands!condor\_annex}
\index{condor\_annex command}

\Synopsis

\SynProg{\Condor{annex}} \Opt{-help}

\SynProg{\Condor{annex}} \OptArg{-setup}{[/full/path/to/access/key/file [/full/path/to/secret/key/file]]}

\SynProg{\Condor{annex}} \oOpt{-aws-on-demand}
  \OptArg{-annex-name}{name of the annex}
  \OptArg{-count}{integer number of instances}
  \oOpt{-aws-on-demand-*}
  \oOpt{common options}

\SynProg{\Condor{annex}} \oOpt{-aws-spot-fleet}
  \OptArg{-annex-name}{name of the annex}
  \OptArg{-slots}{integer weight}
  \oOpt{-aws-spot-fleet-*}
  \oOpt{common options}

\SynProg{\Condor{annex}}
  \OptArg{-annex-name}{name of the annex}
  \OptArg{-duration}{hours}

\SynProg{\Condor{annex}}
  \OptArg{-annex-name}{name of the annex}
  \Opt{-status}
  \oOpt{-classad}

\SynProg{\Condor{annex}} \Opt{-check-setup}

\Description

\condor{annex} adds clouds resources to the pool.  (``The pool'' is determined
in the usual manner for HTCondor daemons and tools.)  Version 8.7.2 supports
only Amazon Web Services (`AWS').  To add ``on-demand'' instances, use
the third form listed above; to add ``spot'' instances, use the fourth.  For an
explanation of terms, consult either the HTCondor manual
(chapter \ref{cloud-computing}) or the AWS documentation.

Using \Condor{annex} with AWS requires a one-time setup procedure
performed by invoking \Condor{annex} with the \Opt{-setup} flag
(the second form listed above).  You may check if this procedure has been
performed with the \Opt{-check-setup} flag (the seventh form listed above).

To reset the lease on an existing annex, invoke \Condor{annex} with
only the \Opt{-annex-name} option and \Opt{-duration} flag (the fifth form
listed above).

To determine which of the instances previously requested for a
particular annex are not currently in the pool, invoke \Condor{annex}
with the \Opt{-status} flag and the \Opt{-annex-name} option (the sixth
form listed above).  The output of this command is intended to be
human-readable; specifying the \Opt{-classad} flag will produce the
same information in ClassAd format.

Common options are listed first, followed by options specific to AWS,
followed by options specific to AWS' on-demand instances, followed by
options specific to AWS' spot instances, followed by options intended
for use by experts.

\begin{Options}
%% COMMON OPTIONS
	\OptItem {\Opt{-help}}
		{Print a usage reminder.}

	\OptItem {\OptArg{-setup}{[/full/path/to/access/key/file /full/path/to/secret/key/file]}}
		{Do the first-time setup.}

	\OptItem {\OptArg{-duration}{hours}}
		{Set the maximum lease duration in decimal \Arg{hours}.  After this amount of time, all instances will terminated, regardless of their idleness.  Defaults to 50 minutes.}
	\OptItem {\OptArg{-idle}{hours}}
		{Set the maximum idle duration in decimal \Arg{hours}.  An instance idle for longer than this duration will terminate itself.  Defaults to 15 minutes.}
	\OptItem {\OptArg{-config-dir}{/full/path/to/directory}}
		{Copy the contents of \Arg{/full/path/to/directory} to each instance's configuration directory.}
	\OptItem {\OptArg{-owner}{owner[, owner]*}}
		{Configure the annex so that only \Arg{owner} may start jobs there.  By default, configure the annex so that only the user running \Condor{annex} may start jobs there.}
	\OptItem {\Opt{-no-owner}}
		{Configure the annex so that anyone in the pool may use the annex.}

%% AWS-SPECIFIC OPTIONS
	\OptItem {\OptArg{-aws-user-data}{user-data}}
		{Set the instance user data to \Arg{user-data}.}
	\OptItem {\OptArg{-aws-user-data-file}{/full/path/to/file}}
		{Set the instance user data to the contents of the file \Arg{/full/path/to/file}.}
	\OptItem {\OptArg{-aws-default-user-data}{user-data}}
		{Set the instance user data to \Arg{user-data}, if it's not already set.  Only applies to spot fleet requests.}
	\OptItem {\OptArg{-aws-default-user-data-file}{/full/path/to/file}}
		{Set the instance user data to the contents of the file \Arg{/full/path/to/file}, if it's not already set.  Only applies to spot fleet requests.}

%% AWS ON-DEMAND OPTIONS
	\OptItem {\OptArg{-aws-on-demand-instance-type}{instance-type}}
		{This annex will requests instances of type \Arg{instance-type}.  The default for v8.7.1 is `m4.large'.}
	\OptItem {\OptArg{-aws-on-demand-ami-id}{ami-id}}
		{This annex will start instances of the AMI \Arg{ami-id}.  The default for v8.7.1 is `ami-35b13223', a GPU-compatible Amazon Linux image with HTCondor pre-installed.}
	\OptItem {\OptArg{-aws-on-demand-security-group-ids}{group-id[,group-id]}}
		{This annex will start instances with the listed security group IDs.  The default is the security group created by \Opt{-setup}.}
	\OptItem {\OptArg{-aws-on-demand-key-name}{key-name}}
		{This annex will start instances with the key pair named \Arg{key-name}.  The default is the key pair created by \Opt{-setup}.}

%% AWS SPOT FLEET OPTIONS
	\OptItem {\OptArg{-aws-spot-fleet-config-file}{/full/path/to/file}}
		{Use the JSON blob in \Arg{/full/path/to/file} for the spot fleet request.}

%% AWS EXPERTS' OPTIONS
	\OptItem {\OptArg{-aws-access-key-file}{/full/path/to/access-key-file}} {Experts only.}
	\OptItem {\OptArg{-aws-secret-key-file}{/full/path/to/secret-key-file}} {Experts only.}
	\OptItem {\OptArg{-aws-ec2-url}{https://ec2.<region>.amazonaws.com}} {Experts only.}
	\OptItem {\OptArg{-aws-events-url}{https://events.<region>.amazonaws.com}} {Experts only.}
	\OptItem {\OptArg{-aws-lambda-url}{https://lambda.<region>.amazonaws.com}} {Experts only.}
	\OptItem {\OptArg{-aws-s3-url}{https://s3.<region>.amazonaws.com}} {Experts only.}
	\OptItem {\OptArg{-aws-spot-fleet-lease-function-arn}{sfr-lease-function-arn}} {Developers only.}
	\OptItem {\OptArg{-aws-on-demand-lease-function-arn}{odi-lease-function-arn}} {Developers only.}
	\OptItem {\OptArg{-aws-on-demand-instance-profile-arn}{instance-profile-arn}} {Developers only.}
\end{Options}

\GenRem

As of v8.7.1, only AWS is supported.  The AMI configured by setup runs
HTCondor v8.6.0 on Amazon Linux 2016.09, and the default instance type
is ``m4.large''.  The default AMI has the appropriate software for AWS'
``p2'' family of GPU instance types.

\Examples

To start an on-demand annex named `MyFirstAnnex' with one core,
using the default AMI and instance type, run

\begin{verbatim}
  condor_annex -count 1 -annex-name MyFirstAnnex
\end{verbatim}

You will be asked to confirm that the defaults are what you want.

As of 2017-04-17, the following example will cost a minimum of \$90.

To start an on-demand annex with 100 GPUs that job owners `big' and `little'
may use (be sure to include yourself!), run

\begin{verbatim}
  condor_annex -count 100 -annex-name MySecondAnnex \
    -aws-on-demand-instance-type p2.xlarge -owner "big, little"
\end{verbatim}

\ExitStatus

\Condor{annex} will exit with a status value of 0 (zero) on success.

\end{ManPage}
